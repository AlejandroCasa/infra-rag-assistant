name: ğŸ›¡ï¸ InfraOps Guardian CI/CD

# Triggers:
# 1. Push to main: Runs Quality Checks + Docker Build & Push (Deployment)
# 2. Pull Request to main: Runs only Quality Checks (Validation)
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Permissions required to push images to GitHub Container Registry (GHCR)
permissions:
  contents: read
  packages: write

jobs:
  # ğŸ§ª JOB 1: QUALITY GATE
  # Runs on every commit to ensure code standards.
  # No Docker build happens if this fails.
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: 'pip' # Cache dependencies for faster runs

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Explicitly install dev tools just in case they are missing from requirements
          pip install black isort mypy pytest pytest-dotenv types-requests types-PyYAML

      - name: ğŸ¨ Linter Check (Black)
        # Fails if code is not formatted correctly
        run: black . --check

      - name: ğŸ§¹ Import Sort Check (Isort)
        # Fails if imports are not sorted according to PEP 8
        run: isort . --check-only

      - name: ğŸ§ Static Type Check (Mypy)
        # Fails if type hints are incorrect or missing
        # Note: Requires a valid mypy.ini or robust configuration
        run: mypy src/

      - name: ğŸ§ª Run Unit Tests (Pytest)
        env:
          # Mock environment variables to prevent test failures during initialization
          # These are dummy values; real tests should use mocks.
          GOOGLE_API_KEY: "dummy_key_for_testing"
          GITHUB_REPO_URL: ""
        run: pytest

  # ğŸ³ JOB 2: DOCKER BUILD & PUSH
  # Only runs on 'main' branch and if quality checks pass.
  docker-build:
    needs: quality-check
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          # GITHUB_TOKEN is automatically provided by GitHub Actions.

      - name: ğŸ·ï¸ Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest
            # Strategy: Keep only 'latest' to stay within free storage limits (500MB)

      - name: ğŸš€ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}